{% extends "base.html" %}
{% block content %}

<div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Upload Script</h2>

    <form id="upload-form" class="space-y-4">
        <input type="text" name="name" placeholder="Script Name" required class="w-full px-3 py-2 border rounded">
        <input type="text" name="description" placeholder="Description" class="w-full px-3 py-2 border rounded">
        <input type="text" name="file_name" placeholder="File Name (e.g. deploy.sh)" required class="w-full px-3 py-2 border rounded">
        <input type="text" name="file_path" placeholder="Local Path (e.g. /home/user/scripts/deploy.sh)" required class="w-full px-3 py-2 border rounded">
        <input type="text" name="tags" placeholder="Tags" class="w-full px-3 py-2 border rounded">

        <label for="server_id" class="block text-sm font-medium text-gray-700">Select Server</label>
        <select name="server_id" id="server-select" required class="w-full px-3 py-2 border border-gray-300 rounded">
            <option value="">Loading...</option>
        </select>

        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Upload Script</button>
    </form>

    <div id="upload-result" class="mt-4 text-sm"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("access_token");

    // Fetch servers and populate dropdown
    try {
        const res = await fetch("/servers/list", {
            headers: { Authorization: `Bearer ${token}` }
        });
        const servers = await res.json();
        const select = document.getElementById("server-select");
        select.innerHTML = servers.map(s =>
            `<option value="${s.id}">${s.hostname} (${s.username})</option>`
        ).join("");
    } catch (err) {
        displayMessage("Failed to load servers.", "error");
        console.error(err);
    }

    // Handle form submission
    document.getElementById("upload-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const msgBox = document.getElementById("upload-result");
        msgBox.innerHTML = "";

        const data = {
            name: form.name.value,
            description: form.description.value,
            file_name: form.file_name.value,
            file_path: form.file_path.value,
            tags: form.tags.value,
            server_id: parseInt(form.server_id.value)
        };

        try {
            const res = await fetch("/scripts/upload", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            const result = await res.json();

            if (res.ok) {
                const scriptId = result.id || "unknown";
                displayMessage(`✅ Script ${data.name}uploaded successfully )`, "success");
                form.reset();
            } else {
                let errorMessage = "Upload failed.";
                if (result.detail) {
                    if (typeof result.detail === "string") {
                        errorMessage = result.detail;
                    } else if (Array.isArray(result.detail)) {
                        errorMessage = result.detail.map(d => `• <b>${d.loc.join('.')}</b>: ${d.msg}`).join("<br>");
                    } else {
                        errorMessage = JSON.stringify(result.detail, null, 2);
                    }
                }
                displayMessage(errorMessage, "error");
            }
        } catch (err) {
            console.error("Request failed:", err);
            displayMessage("Request failed due to network or server error.", "error");
        }
    });

    // Message helper
    function displayMessage(message, type = "success") {
        const msgBox = document.getElementById("upload-result");
        const baseClasses = "px-4 py-3 rounded text-sm";
        if (type === "success") {
            msgBox.className = `${baseClasses} bg-green-100 text-green-800 border border-green-300`;
        } else {
            msgBox.className = `${baseClasses} bg-red-100 text-red-800 border border-red-300`;
        }
        msgBox.innerHTML = message;
    }
});
</script>

{% endblock %}
