{% extends "base.html" %}

{% block title %}Script Details{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Script Details</h2>

    <div id="script-details" class="text-sm text-gray-800 bg-gray-50 p-4 rounded border mb-4">
        Loading...
    </div>

    <div class="flex gap-4">
        <button id="execute-button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Execute</button>
        <button id="delete-button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
    </div>

    <div id="action-status" class="mt-4 text-sm font-medium"></div>
</div>

<script>
    
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("access_token");
    const scriptId = window.location.pathname.split("/").pop();
    const output = document.getElementById("script-details");
    const statusDiv = document.getElementById("action-status");

    // Load script details
    try {
        const res = await fetch(`/scripts/${scriptId}`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
            const err = await res.json();
            output.innerText = err.detail || "Script not found.";
            return;
        }

        const script = await res.json();
        output.innerHTML = `
            <strong>ID:</strong> ${script.id}<br>
            <strong>Name:</strong> ${script.name}<br>
            <strong>Description:</strong> ${script.description || "N/A"}<br>
            <strong>File Name:</strong> ${script.file_name}<br>
            <strong>File Path:</strong> ${script.file_path}<br>
            <strong>Hostname:</strong> ${script.hostname}<br>
            <strong>Username:</strong> ${script.username}<br>
            <strong>Runner:</strong> ${script.runner}<br>
            <strong>Tags:</strong> ${script.tags || "None"}<br>
            <strong>Created At:</strong> ${new Date(script.created_at).toLocaleString()}<br>
            <strong>Updated At:</strong> ${new Date(script.updated_at).toLocaleString()}
        `;
    } catch (err) {
        console.error(err);
        output.innerText = "An error occurred while fetching script details.";
    }

    // Handle Execute
    document.getElementById("execute-button").addEventListener("click", async () => {
        try {
            statusDiv.innerText = "Executing...";
            const res = await fetch(`/scripts/execute/${scriptId}`, {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` }
            });

            const result = await res.json();
            if (!res.ok) throw result;

            statusDiv.innerText = `✅ Executed: ${result.detail || "Success"}`;
            statusDiv.classList.remove("text-red-600");
            statusDiv.classList.add("text-green-600");
        } catch (err) {
            statusDiv.innerText = `❌ Execution failed: ${err.detail || err.message}`;
            statusDiv.classList.remove("text-green-600");
            statusDiv.classList.add("text-red-600");
        }
    });

    // Handle Delete
    document.getElementById("delete-button").addEventListener("click", async () => {
        if (!confirm("Are you sure you want to delete this script?")) return;

        try {
            statusDiv.innerText = "Deleting...";
            const res = await fetch(`/scripts/${scriptId}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` }
            });

            if (!res.ok) {
                const err = await res.json();
                throw err;
            }

            statusDiv.innerText = "✅ Script deleted successfully. Redirecting...";
            statusDiv.classList.remove("text-red-600");
            statusDiv.classList.add("text-green-600");

            setTimeout(() => {
                window.location.href = "/scripts_ui"; // Update this route if needed
            }, 1500);
        } catch (err) {
            statusDiv.innerText = `❌ Delete failed: ${err.detail || err.message}`;
            statusDiv.classList.remove("text-green-600");
            statusDiv.classList.add("text-red-600");
        }
    });
});
</script>
{% endblock %}
